### nginx location 匹配优先级



#### 精确匹配

​	`=`指令用于精确字符匹配（模式），不能使用正则，区分大小写。

```
location = /demo {
    rewrite ^ http://google.com;
}
```

上述的配置表示只有访问 `http://192.168.33.10/demo` 这样的url，才能跳转到google的页面。除此之外的任何地址都无法访问，那怕是访问`http://192.168.33.10/demo/`这个地址也不行。因为url匹配模式是`/demo`。

#### 前缀匹配

​	`^~`指令用于字符前缀匹配，和`=`精确匹配一样，也是用于字符确定的匹配，不能使用正则且区分大小写。和`=`不同的在于，`^~`指令下，访问的url无需url匹配模式一模一样，只需要其开头前缀和url匹配模式一样即可。

```
location ^~ /demo {
    rewrite ^ http://google.com;
}
```

对于该模式（`/demo`），访问下列的地址都能匹配：

- http://192.168.33.10/demo
- http://192.168.33.10/demo/
- http://192.168.33.10/demo/aaa
- http://192.168.33.10/demo/aaa/bbb
- http://192.168.33.10/demo/AAA
- http://192.168.33.10/demoaaa
- http://192.168.33.10/demo.aaa

#### 正则匹配

​	使用`~`或`~*`，`~`区分大小写，`~*`不区分大小写，正则匹配也是只需匹配以url模式开头的即可。

```
location ~ /[0-9]emo {
    rewrite ^ http://google.com;
}
```

对于上述的模式，可以匹配的url如下：

- http://192.168.33.10/5emo
- http://192.168.33.10/9emo
- http://192.168.33.10/5emo/aaa
- http://192.168.33.10/5emo/AAA
- http://192.168.33.10/5emoaaa

只要是以正则表达式`/[0-9]emo`匹配的字符开头的url，都能匹配。

#### 正常匹配

​	正常匹配的指令为空，即没有指定匹配指令的即为正常匹配。其形式类似 `/XXX/YYY.ZZZ`正常匹配中的url匹配模式不可以使用正则，不区分大小写。

```
location /demo {
    rewrite ^ http://google.com;
}
```

上述模式指的是匹配`/demo`的url，下面的都能匹配

- http://192.168.33.10/demo
- http://192.168.33.10/demo/
- http://192.168.33.10/demo/aaa
- http://192.168.33.10/demo/aaa/bbb
- http://192.168.33.10/demo/AAA
- http://192.168.33.10/demoaaa
- http://192.168.33.10/demo.aaa

#### 全匹配

​	全匹配与正常匹配一样，没有匹配指令，匹配的url模式仅一个斜杠`/`

```
location / {
    rewrite ^ http://google.com;
}
```

全匹配也可以配合 精确匹配和正则匹配一些指令，只不过这样的设定意义不大。通过都会有一个默认的location，这个就是全匹配。

#### 命名匹配

​	命名匹配指的是使用`@`比绑定一个模式，类似变量替换的用法。

```
error_page 404 = @not_found

location @not_found {
      rewrite http://google.com;
}
```

上述的作用是如果访问没有匹配的url会触发404指令，然后就匹配到`@not_found` 这个 location上。

#### 匹配优先级

nginx的匹配优先级遵循**一个大原则**和**两个小细节**。

大原则是关于匹配模式的优先级：

```
精确匹配  >  前缀匹配  >  正则匹配  > 正常匹配  > 全匹配
```

小细节则是同一优先级中：

- 细节一：正则匹配成功之后停止匹配，非正则匹配成功还会接着匹配。
- 细节二：在所有匹配成功的url中，选取匹配度最大的url字符地址。